# RAM Usage Analysis and Optimization Report - MidiCore STM32F407

**Date**: 2026-01-27  
**Target**: STM32F407VGT6 (128 KB RAM + 64 KB CCMRAM)  
**Status**: âš ï¸ RAM OVERFLOW - Requires optimization

---

## Executive Summary

This report provides a comprehensive analysis of RAM usage across all modules in the MidiCore firmware for STM32F407. The analysis identified a **RAM overflow of 11.6 KB** (8.9% over the 128 KB limit) and provides actionable optimization recommendations.

### Current Memory Status

| Memory Section | Size | % of Limit | Status |
|---------------|------|------------|---------|
| **RAM (.bss + .data)** | 142,748 bytes (139.4 KB) | 108.9% | âš ï¸ **OVERFLOW +11.6 KB** |
| **CCMRAM** | 37,024 bytes (36.2 KB) | 56.5% | âœ“ OK (27.8 KB available) |
| **Total** | 179,772 bytes (175.6 KB) | 91.4% | âš ï¸ Requires RAM reduction |

---

## Detailed Analysis Methodology

### Tools Used

1. **parse_map_detailed.py**
   - Parses linker .map file to extract memory sections
   - Categorizes symbols by module, file, and memory section
   - Identifies large memory allocations (>1KB)
   - Exports detailed CSV reports

2. **find_redundancy.py**
   - Analyzes source code for duplicate functions
   - Identifies similar code patterns across modules
   - Detects common library usage patterns
   - Suggests refactoring opportunities

3. **Linker Map File Analysis**
   - Source: `Debug/MidiCore.map`
   - Generated by: ARM GCC Linker (STM32CubeIDE)
   - Provides symbol-level memory allocation details

### Analysis Process

1. âœ… Parsed linker map file (2.7 MB, 814 symbols extracted)
2. âœ… Categorized memory usage by module and file
3. âœ… Identified large static allocations
4. âœ… Analyzed 1,014 functions across 147 source files
5. âœ… Detected duplicate and similar code patterns
6. âœ… Measured common library usage patterns

---

## Top Memory Consumers

### By Module (BSS Section Only)

| Rank | Module | BSS Usage | % of Total RAM | Key Symbols |
|------|--------|-----------|----------------|-------------|
| 1 | Services/looper | 42,111 B (41.1 KB) | 29.5% | undo_stacks (41.2 KB) |
| 2 | Services/patch | 43,396 B (42.4 KB) | 30.4% | g_entries (41.0 KB) |
| 3 | Middlewares/FreeRTOS | 13,797 B (13.5 KB) | 9.7% | ucHeap (10.2 KB), task lists (1.1 KB) |
| 4 | Services/cli | 13,067 B (12.8 KB) | 9.2% | s_commands (10.2 KB), s_history (2.6 KB) |
| 5 | Services/ui | 6,737 B (6.6 KB) | 4.7% | snap buffer (6.1 KB) |
| 6 | Services/router | 5,128 B (5.0 KB) | 3.6% | g_routes (5.1 KB) |
| 7 | USB_DEVICE | 3,024 B (3.0 KB) | 2.1% | hpcd_USB_OTG_FS (1.3 KB) |
| 8 | Services/log | 2,306 B (2.3 KB) | 1.6% | g_lines (2.3 KB) |
| 9 | Services/ain | 2,052 B (2.0 KB) | 1.4% | g_keys (1.3 KB) |
| 10 | Services/midi_monitor | 1,840 B (1.8 KB) | 1.3% | event_buffer (1.8 KB) |

### Large Static Arrays (>1 KB each)

| Symbol | Size | Location | Purpose |
|--------|------|----------|---------|
| undo_stacks | 41,216 B | Services/looper/looper.c | Looper undo/redo history (per track) |
| g_entries | 40,960 B | Services/patch/patch_adv.c | Patch management entries |
| ucHeap | 10,240 B | FreeRTOS heap_4.c | FreeRTOS heap allocator |
| s_commands | 10,240 B | Services/cli/cli.c | CLI command registry |
| snap | 6,144 B | Services/ui/ui_page_looper_timeline.c | Timeline snapshot buffer |
| g_routes | 5,120 B | Services/router/router.c | MIDI routing matrix |
| s_history | 2,560 B | Services/cli/cli.c | CLI command history |
| g_lines | 2,304 B | Services/log/log.c | Log buffer lines |
| event_buffer | 1,792 B | Services/midi_monitor/midi_monitor.c | MIDI event monitor buffer |
| g_keys | 1,280 B | Services/ain/ain.c | Analog input key states |
| hpcd_USB_OTG_FS | 1,252 B | USB_DEVICE/Target/usbd_conf.c | USB device handle |
| pxReadyTasksLists | 1,120 B | FreeRTOS/tasks.c | FreeRTOS task ready lists |
| sysex_buffers | 1,040 B | Services/usb_midi/usb_midi.c | USB MIDI SysEx buffers |
| q | 1,024 B | Services/midi/midi_delayq.c | MIDI delay queue |

---

## Code Redundancy Analysis

### Exact Duplicate Functions (7 found)

| Function | Locations | Lines | Optimization Potential |
|----------|-----------|-------|------------------------|
| am_keyeq / mr_keyeq / dm_keyeq | ainser_map.c, midi_router.c, din_map.c | 9 | Create shared utility function â†’ Save ~50 bytes |
| ieq | patch_router.c, zones_cfg.c, instrument_cfg.c | 7 | Create shared string comparison â†’ Save ~40 bytes |
| keyeq | pressure_i2c.c, expression_cfg.c | 7 | Consolidate string comparison â†’ Save ~30 bytes |
| parse_u32 | ui_encoders.c, ui_bindings.c | 7 | Create shared UI utility â†’ Save ~30 bytes |
| wrap_tick_i32 | ui_page_looper_pianoroll.c, ui_page_looper_timeline.c | 7 | Shared timing function â†’ Save ~30 bytes |
| gpio_pin_index | module_tests.c, test_debug.c | 7 | Test utility function â†’ Save ~30 bytes |
| trim | zones_cfg.c, instrument_cfg.c | 6 | Shared string utility â†’ Save ~25 bytes |

**Total Potential Savings from Deduplication**: ~235 bytes

### Similar Functions (11 patterns identified)

| Pattern | Occurrences | Total Lines | Description |
|---------|-------------|-------------|-------------|
| CLI response functions | 3 | 30 | cli_error, cli_success, cli_warning - could use macro |
| Test functions | 4 | 28 | Similar test structure - template possible |
| Key comparison | 3 | 27 | am_keyeq, mr_keyeq, dm_keyeq variants |
| Config parsing | 3 | 21 | ieq variants in different modules |

### Common Library Usage Patterns

| Pattern | Count | Files | Optimization Notes |
|---------|-------|-------|-------------------|
| memset_zero | 71 | 57 | Standard pattern, minimal optimization |
| snprintf | 57 | 27 | Consider format string consolidation |
| strncpy | 46 | 25 | Ensure buffer safety, no change needed |
| memcpy | 36 | 25 | Standard usage, efficient |
| strlen | 24 | 18 | Standard usage |
| strcpy | 2 | 2 | Minimal usage (good - prefer strncpy) |

---

## Optimization Recommendations

### Priority 1: Critical RAM Reductions (Required to Fit in 128 KB)

#### 1.1 Reduce Looper Undo Stack Depth (HIGHEST PRIORITY)
**Target**: Services/looper/looper.c:1764  
**Current**: undo_stacks = 41,216 bytes (CCMRAM placement in production)  
**Issue**: Already in CCMRAM, but very large allocation

```c
// Current configuration (looper.h):
#ifndef LOOPER_UNDO_DEPTH
#define LOOPER_UNDO_DEPTH 5  // Current: 5 levels per track
#endif

// Recommended:
#ifndef LOOPER_UNDO_DEPTH
#define LOOPER_UNDO_DEPTH 3  // Reduce to 3 levels
#endif
```

**Impact**: 41,216 Ã— (2/5) = **16,486 bytes saved** (40% reduction)  
**Risk**: Low - 3 levels of undo is still usable for most scenarios

#### 1.2 Optimize Patch Entry Array
**Target**: Services/patch/patch_adv.c  
**Current**: g_entries = 40,960 bytes

```c
// Current (estimated structure):
typedef struct {
    char name[256];  // Very large
    // ... other fields
} patch_entry_t;
static patch_entry_t g_entries[MAX_PATCHES];

// Recommended:
typedef struct {
    char name[64];   // Reduce name length
    // ... other fields
} patch_entry_t;
// Or reduce MAX_PATCHES from current value
```

**Impact**: Depends on struct layout - **~10-20 KB potential savings**  
**Risk**: Medium - Requires analysis of actual usage

#### 1.3 Reduce CLI Command Registry
**Target**: Services/cli/cli.c  
**Current**: s_commands = 10,240 bytes

```c
// Estimated current:
#define CLI_MAX_COMMANDS 64  // Too many?

// Recommended:
#define CLI_MAX_COMMANDS 32  // Sufficient for most use cases
```

**Impact**: **~5,120 bytes saved** (50% reduction)  
**Risk**: Low - Most firmwares use <32 CLI commands

#### 1.4 Reduce CLI History Buffer
**Target**: Services/cli/cli.c  
**Current**: s_history = 2,560 bytes

```c
// Current (estimated):
#define CLI_HISTORY_SIZE 64

// Recommended:
#define CLI_HISTORY_SIZE 32
```

**Impact**: **~1,280 bytes saved**  
**Risk**: Very Low - 32 command history is sufficient

#### 1.5 Reduce UI Timeline Snapshot Buffer
**Target**: Services/ui/ui_page_looper_timeline.c  
**Current**: snap = 6,144 bytes

```c
// Current (estimated):
#define MAX_SNAP 512

// Recommended:
#define MAX_SNAP 256  // Still shows substantial event data
```

**Impact**: **~3,072 bytes saved**  
**Risk**: Low - 256 events is adequate for timeline view

#### 1.6 Reduce Log Buffer
**Target**: Services/log/log.c  
**Current**: g_lines = 2,304 bytes

```c
// Current (estimated):
#define MAX_LOG_LINES 32

// Recommended:
#define MAX_LOG_LINES 16  // For production
```

**Impact**: **~1,152 bytes saved**  
**Risk**: Low - Can use conditional compilation for debug builds

### Priority 1 Total Savings: ~37 KB
**Result**: Would reduce RAM usage to ~102 KB (well within 128 KB limit)

---

### Priority 2: Code Deduplication (Small Gains, High Value)

#### 2.1 Create Shared String Utilities

**Create**: `Services/safe/safe_string.h` and `safe_string.c`

```c
// Consolidate duplicate functions
bool string_key_equals(const char* a, const char* b);
bool string_iequals(const char* a, const char* b);
char* string_trim(char* str);
```

**Replace in**:
- ainser_map.c, midi_router.c, din_map.c (am_keyeq variants)
- patch_router.c, zones_cfg.c, instrument_cfg.c (ieq variants)
- pressure_i2c.c, expression_cfg.c (keyeq variants)
- zones_cfg.c, instrument_cfg.c (trim variants)

**Impact**: ~145 bytes CODE savings, ~0 bytes RAM savings  
**Benefit**: Better maintainability, reduced duplication

#### 2.2 Create Shared UI Utilities

**Create**: `Services/ui/ui_common.h` and `ui_common.c`

```c
// Consolidate UI helper functions
uint32_t parse_u32(const char* str);
int32_t wrap_tick_i32(int32_t tick, int32_t max);
int note_to_y(int note, int note_min, int note_max, int height);
```

**Replace in**:
- ui_encoders.c, ui_bindings.c (parse_u32)
- ui_page_looper_pianoroll.c, ui_page_looper_timeline.c (wrap_tick_i32, note_to_y)

**Impact**: ~90 bytes CODE savings  
**Benefit**: Consistent UI behavior, easier maintenance

---

### Priority 3: Conditional Compilation (Development vs Production)

#### 3.1 Debug Features

```c
// In Config/module_config.h or similar

#ifdef PRODUCTION_MODE
  #define LOG_MAX_LINES 16
  #define CLI_HISTORY_SIZE 16
  #define CLI_MAX_COMMANDS 32
  #define LOOPER_UNDO_DEPTH 3
  #define MIDI_MONITOR_BUFFER_SIZE 256  // Reduce from 512
#else
  #define LOG_MAX_LINES 32
  #define CLI_HISTORY_SIZE 64
  #define CLI_MAX_COMMANDS 64
  #define LOOPER_UNDO_DEPTH 5
  #define MIDI_MONITOR_BUFFER_SIZE 512
#endif
```

**Impact**: Provides flexibility for development while ensuring production fits  
**Benefit**: No functionality loss during development

---

## Implementation Priority

### Phase 1: Critical Reductions (Required)
1. âœ… Reduce looper undo depth (Priority 1.1) - **~16 KB saved**
2. âœ… Reduce UI timeline snap buffer (Priority 1.5) - **~3 KB saved**
3. âœ… Reduce CLI buffers (Priority 1.3, 1.4) - **~6 KB saved**
4. âœ… Reduce log buffer (Priority 1.6) - **~1 KB saved**

**Phase 1 Total**: ~26 KB saved â†’ RAM usage becomes ~117 KB âœ…

### Phase 2: Patch System Optimization (If needed)
5. Analyze and optimize patch entry structure (Priority 1.2) - **~10-20 KB potential**

### Phase 3: Code Quality Improvements
6. Deduplicate string utilities (Priority 2.1) - **~145 bytes CODE**
7. Deduplicate UI utilities (Priority 2.2) - **~90 bytes CODE**
8. Implement conditional compilation (Priority 3.1) - **Flexibility**

---

## Verification Plan

### Before Optimization
```bash
# Capture current state
arm-none-eabi-size -A Debug/MidiCore.elf > before_size.txt
cp Debug/MidiCore.map before_MidiCore.map
python3 Tools/parse_map_detailed.py Debug/MidiCore.map before_optimization
```

### After Each Optimization
```bash
# Clean rebuild required
make clean && make all

# Verify memory usage
arm-none-eabi-size -A Debug/MidiCore.elf
python3 Tools/parse_map_detailed.py Debug/MidiCore.map after_phase1

# Compare
diff before_size.txt after_size.txt
```

### Functional Testing
1. **Looper**: Test undo/redo with reduced depth
2. **CLI**: Test command entry and history
3. **UI**: Test timeline view with reduced snap buffer
4. **Logging**: Verify log rotation works with smaller buffer
5. **Patch System**: If modified, test patch loading/saving

---

## Risk Assessment

| Change | Risk Level | Mitigation |
|--------|------------|------------|
| Reduce undo depth | ðŸŸ¡ Low-Medium | Already in CCMRAM, reducing from 5 to 3 is acceptable |
| Reduce CLI buffers | ðŸŸ¢ Low | 32 commands and 32 history entries sufficient |
| Reduce UI snap buffer | ðŸŸ¢ Low | 256 events still provides good visibility |
| Reduce log buffer | ðŸŸ¢ Low | 16 lines adequate for production |
| Optimize patch entries | ðŸŸ  Medium | Requires careful analysis of structure usage |
| Code deduplication | ðŸŸ¢ Very Low | Pure refactoring, no functional change |

---

## Files Modified (Estimated)

### Phase 1 Changes:
- `Services/looper/looper.h` - Reduce LOOPER_UNDO_DEPTH
- `Services/cli/cli.c` - Reduce CLI_MAX_COMMANDS, CLI_HISTORY_SIZE  
- `Services/ui/ui_page_looper_timeline.c` - Reduce MAX_SNAP
- `Services/log/log.c` - Reduce MAX_LOG_LINES
- `Config/module_config.h` (create if needed) - Central configuration

### Phase 3 Changes:
- `Services/safe/safe_string.c` (new) - Shared string utilities
- `Services/safe/safe_string.h` (new)
- `Services/ui/ui_common.c` (new) - Shared UI utilities
- `Services/ui/ui_common.h` (new)
- Multiple modules - Update to use shared functions

---

## Success Criteria

âœ… **Primary Goal**: RAM usage < 128 KB (currently 139.4 KB, need to reduce by >11.4 KB)  
âœ… **Secondary Goal**: Eliminate code duplication where safe  
âœ… **Tertiary Goal**: Improve build-time configurability  
âœ… **Validation**: All core functionality working after changes

---

## Tools and Scripts Developed

All analysis tools are located in `Tools/` directory:

1. **parse_map_detailed.py** - Comprehensive map file parser
   ```bash
   python3 Tools/parse_map_detailed.py Debug/MidiCore.map [output_prefix]
   ```
   - Generates module/file/symbol CSV reports
   - Identifies large allocations
   - Calculates memory usage percentages

2. **find_redundancy.py** - Code duplication detector
   ```bash
   python3 Tools/find_redundancy.py .
   ```
   - Finds exact duplicate functions
   - Identifies similar code patterns
   - Suggests refactoring opportunities

3. **analyze_ram.py** - Quick RAM summary
   ```bash
   python3 Tools/analyze_ram.py Debug/MidiCore.map
   ```
   - Fast overview of memory sections
   - Top consumers at a glance

---

## References

- **STM32F407VG Datasheet**: 128 KB RAM + 64 KB CCMRAM specification
- **Linker Map File**: `Debug/MidiCore.map` (generated by ARM GCC)
- **Existing Documentation**:
  - `RAM_OPTIMIZATION_REPORT.md` - Previous optimization efforts
  - `MEMORY_OPTIMIZATION_50KB.md` - Memory optimization history
  - `PRODUCTION_MODE_COMPLETE.md` - Production configuration guide

---

## Conclusion

The MidiCore firmware currently exceeds STM32F407VG RAM capacity by 11.6 KB (8.9%). This analysis identified specific optimization opportunities that can reduce RAM usage by ~26-37 KB through targeted buffer size reductions. These changes are low-risk and preserve all essential functionality while ensuring the firmware fits comfortably within hardware limits.

The recommended Phase 1 optimizations are sufficient to meet requirements and should be implemented first. Phase 2 and 3 optimizations provide additional benefits for code quality and maintainability but are not strictly required for the firmware to function.

---

**Report Generated**: 2026-01-27  
**Analysis Tools Version**: 1.0  
**Total Analysis Time**: ~30 minutes  
**Files Analyzed**: 147 source files, 814 memory symbols, 1,014 functions
