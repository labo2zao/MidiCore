#include "Services/ui/ui_gfx.h"
#include <string.h>
#include <stdlib.h>  // For abs()

static uint8_t* g_fb = 0;
static uint16_t g_w = 0, g_h = 0;

static const uint8_t font5x7[96][5] = {
  {0,0,0,0,0},{0,0,0x5F,0,0},{0,0x07,0,0x07,0},{0x14,0x7F,0x14,0x7F,0x14},
  {0x24,0x2A,0x7F,0x2A,0x12},{0x23,0x13,0x08,0x64,0x62},{0x36,0x49,0x55,0x22,0x50},{0,0x05,0x03,0,0},
  {0,0x1C,0x22,0x41,0},{0,0x41,0x22,0x1C,0},{0x14,0x08,0x3E,0x08,0x14},{0x08,0x08,0x3E,0x08,0x08},
  {0,0x50,0x30,0,0},{0x08,0x08,0x08,0x08,0x08},{0,0x60,0x60,0,0},{0x20,0x10,0x08,0x04,0x02},
  {0x3E,0x51,0x49,0x45,0x3E},{0,0x42,0x7F,0x40,0},{0x42,0x61,0x51,0x49,0x46},{0x21,0x41,0x45,0x4B,0x31},
  {0x18,0x14,0x12,0x7F,0x10},{0x27,0x45,0x45,0x45,0x39},{0x3C,0x4A,0x49,0x49,0x30},{0x01,0x71,0x09,0x05,0x03},
  {0x36,0x49,0x49,0x49,0x36},{0x06,0x49,0x49,0x29,0x1E},{0,0x36,0x36,0,0},{0,0x56,0x36,0,0},
  {0x08,0x14,0x22,0x41,0},{0x14,0x14,0x14,0x14,0x14},{0,0x41,0x22,0x14,0x08},{0x02,0x01,0x51,0x09,0x06},
  {0x32,0x49,0x79,0x41,0x3E},{0x7E,0x11,0x11,0x11,0x7E},{0x7F,0x49,0x49,0x49,0x36},{0x3E,0x41,0x41,0x41,0x22},
  {0x7F,0x41,0x41,0x22,0x1C},{0x7F,0x49,0x49,0x49,0x41},{0x7F,0x09,0x09,0x09,0x01},{0x3E,0x41,0x49,0x49,0x7A},
  {0x7F,0x08,0x08,0x08,0x7F},{0,0x41,0x7F,0x41,0},{0x20,0x40,0x41,0x3F,0x01},{0x7F,0x08,0x14,0x22,0x41},
  {0x7F,0x40,0x40,0x40,0x40},{0x7F,0x02,0x0C,0x02,0x7F},{0x7F,0x04,0x08,0x10,0x7F},{0x3E,0x41,0x41,0x41,0x3E},
  {0x7F,0x09,0x09,0x09,0x06},{0x3E,0x41,0x51,0x21,0x5E},{0x7F,0x09,0x19,0x29,0x46},{0x46,0x49,0x49,0x49,0x31},
  {0x01,0x01,0x7F,0x01,0x01},{0x3F,0x40,0x40,0x40,0x3F},{0x1F,0x20,0x40,0x20,0x1F},{0x7F,0x20,0x18,0x20,0x7F},
  {0x63,0x14,0x08,0x14,0x63},{0x03,0x04,0x78,0x04,0x03},{0x61,0x51,0x49,0x45,0x43},{0,0x7F,0x41,0x41,0},
  {0x02,0x04,0x08,0x10,0x20},{0,0x41,0x41,0x7F,0},{0x04,0x02,0x01,0x02,0x04},{0x40,0x40,0x40,0x40,0x40},
  {0,0x01,0x02,0x04,0},{0x20,0x54,0x54,0x54,0x78},{0x7F,0x48,0x44,0x44,0x38},{0x38,0x44,0x44,0x44,0x20},
  {0x38,0x44,0x44,0x48,0x7F},{0x38,0x54,0x54,0x54,0x18},{0x08,0x7E,0x09,0x01,0x02},{0x0C,0x52,0x52,0x52,0x3E},
  {0x7F,0x08,0x04,0x04,0x78},{0,0x44,0x7D,0x40,0},{0x20,0x40,0x44,0x3D,0},{0x7F,0x10,0x28,0x44,0},
  {0,0x41,0x7F,0x40,0},{0x7C,0x04,0x18,0x04,0x78},{0x7C,0x08,0x04,0x04,0x78},{0x38,0x44,0x44,0x44,0x38},
  {0x7C,0x14,0x14,0x14,0x08},{0x08,0x14,0x14,0x18,0x7C},{0x7C,0x08,0x04,0x04,0x08},{0x48,0x54,0x54,0x54,0x20},
  {0x04,0x3F,0x44,0x40,0x20},{0x3C,0x40,0x40,0x20,0x7C},{0x1C,0x20,0x40,0x20,0x1C},{0x3C,0x40,0x30,0x40,0x3C},
  {0x44,0x28,0x10,0x28,0x44},{0x0C,0x50,0x50,0x50,0x3C},{0x44,0x64,0x54,0x4C,0x44},{0,0x08,0x36,0x41,0},
  {0,0,0x7F,0,0},{0,0x41,0x36,0x08,0},{0x08,0x04,0x08,0x10,0x08},
};

void ui_gfx_set_fb(uint8_t* fb, uint16_t w, uint16_t h) { g_fb = fb; g_w = w; g_h = h; }

void ui_gfx_clear(uint8_t gray) {
  if (!g_fb) return;
  uint8_t v = (uint8_t)(((gray & 0x0F) << 4) | (gray & 0x0F));
  memset(g_fb, v, (g_w * g_h) / 2);
}

void ui_gfx_pixel(int x, int y, uint8_t gray) {
  if (!g_fb) return;
  if (x < 0 || y < 0 || x >= (int)g_w || y >= (int)g_h) return;
  uint32_t idx = (uint32_t)y * (uint32_t)g_w + (uint32_t)x;
  uint32_t b = idx >> 1;
  if ((idx & 1u) == 0) g_fb[b] = (uint8_t)((g_fb[b] & 0x0F) | ((gray & 0x0F) << 4));
  else                g_fb[b] = (uint8_t)((g_fb[b] & 0xF0) |  (gray & 0x0F));
}

void ui_gfx_rect(int x, int y, int w, int h, uint8_t gray) {
  for (int yy=0; yy<h; yy++) for (int xx=0; xx<w; xx++) ui_gfx_pixel(x+xx, y+yy, gray);
}

static void draw_char(int x, int y, char c, uint8_t gray) {
  if (c < 32 || c > 127) c = '?';
  const uint8_t* col = font5x7[(int)c - 32];
  for (int cx=0; cx<5; cx++) {
    uint8_t bits = col[cx];
    for (int cy=0; cy<7; cy++) if (bits & (1u<<cy)) ui_gfx_pixel(x+cx, y+cy, gray);
  }
}

void ui_gfx_text(int x, int y, const char* s, uint8_t gray) {
  if (!s) return;
  int cx = x;
  while (*s) {
    if (*s == '\n') { cx = x; y += 8; s++; continue; }
    draw_char(cx, y, *s, gray);
    cx += 6;
    s++;
  }
}

void ui_gfx_fill_rect(int x, int y, int w, int h, uint8_t gray) {
  ui_gfx_rect(x, y, w, h, gray);
}

void ui_gfx_hline(int x, int y, int w, uint8_t gray) {
  for (int xx = 0; xx < w; xx++) {
    ui_gfx_pixel(x + xx, y, gray);
  }
}

void ui_gfx_vline(int x, int y, int h, uint8_t gray) {
  for (int yy = 0; yy < h; yy++) {
    ui_gfx_pixel(x, y + yy, gray);
  }
}

// Bresenham's line algorithm
void ui_gfx_line(int x0, int y0, int x1, int y1, uint8_t gray) {
  int dx = x1 - x0;
  int dy = y1 - y0;
  
  // Handle negative deltas - determine step direction and get absolute values
  int sx = (dx > 0) ? 1 : -1;
  int sy = (dy > 0) ? 1 : -1;
  dx = abs(dx);
  dy = abs(dy);
  
  int err = dx - dy;
  
  while (1) {
    ui_gfx_pixel(x0, y0, gray);
    
    if (x0 == x1 && y0 == y1) break;
    
    int e2 = 2 * err;
    if (e2 > -dy) {
      err -= dy;
      x0 += sx;
    }
    if (e2 < dx) {
      err += dx;
      y0 += sy;
    }
  }
}

// Midpoint circle algorithm
void ui_gfx_circle(int cx, int cy, int radius, uint8_t gray) {
  int x = radius;
  int y = 0;
  int err = 0;
  
  while (x >= y) {
    // Draw 8 octants
    ui_gfx_pixel(cx + x, cy + y, gray);
    ui_gfx_pixel(cx + y, cy + x, gray);
    ui_gfx_pixel(cx - y, cy + x, gray);
    ui_gfx_pixel(cx - x, cy + y, gray);
    ui_gfx_pixel(cx - x, cy - y, gray);
    ui_gfx_pixel(cx - y, cy - x, gray);
    ui_gfx_pixel(cx + y, cy - x, gray);
    ui_gfx_pixel(cx + x, cy - y, gray);
    
    if (err <= 0) {
      y++;
      err += 2 * y + 1;
    }
    
    if (err > 0) {
      x--;
      err -= 2 * x + 1;
    }
  }
}
